<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thrips Nucleotide Database with BLAST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root" class="min-h-screen">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-green-600 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M2 15c6.667-6 13.333 0 20-6"></path>
                                <path d="M9 22c1.798-1.998 2.518-3.995 2.807-5.993"></path>
                                <path d="M15 2c-1.798 1.998-2.518 3.995-2.807 5.993"></path>
                                <path d="m17 6-2.5-2.5"></path>
                                <path d="m14 8-1-1"></path>
                                <path d="m7 18 2.5 2.5"></path>
                                <path d="m3.5 14.5.5.5"></path>
                                <path d="m20 9 .5.5"></path>
                                <path d="m6.5 12.5 1 1"></path>
                                <path d="m16.5 10.5 1 1"></path>
                                <path d="m10 16 1.5 1.5"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Thrips Nucleotide Database</h1>
                            <p class="text-sm text-gray-500">Comprehensive Gene Barcode Repository with BLAST Analysis</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-gray-900" id="totalCount">0</div>
                        <div class="text-xs text-gray-500">Total Entries</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Modal -->
        <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-green-600 mb-4"></div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Loading Database</h3>
                    <p class="text-sm text-gray-600 text-center">Fetching thrips sequences...</p>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                <div class="flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                        <span class="text-3xl text-red-600">⚠️</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Database</h3>
                    <p class="text-sm text-gray-600 mb-4" id="errorText"></p>
                    <button onclick="window.location.reload()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Retry
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-6 py-6" id="mainContent" style="display: none;">
            
            <!-- Search and Filter Bar -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <div class="absolute left-3 top-3 w-5 h-5 text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                            </div>
                            <input type="text" id="searchInput" placeholder="Search by species, accession, gene marker..." 
                                   class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            <span id="filteredCount">0</span> of <span id="totalCount2">0</span> sequences
                        </div>
                    </div>
                    <select id="sortSelect" class="px-4 py-2 border rounded-lg bg-white hover:bg-gray-50">
                        <option value="species">Sort by Species</option>
                        <option value="accession">Sort by Accession</option>
                        <option value="length">Sort by Length</option>
                    </select>
                </div>

                <!-- Selection Actions -->
                <div id="selectionBar" class="mt-4 hidden flex flex-wrap items-center justify-between gap-3 bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <div class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <span class="text-sm font-medium text-blue-900">
                            <span id="selectedCount">0</span> sequence(s) selected
                        </span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="viewSelectedSequences()" class="px-3 py-2 bg-white border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 flex items-center space-x-2 text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <span>View</span>
                        </button>
                        <button onclick="runBlast()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2 text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"></path>
                            </svg>
                            <span>BLAST</span>
                        </button>
                        <button onclick="exportFasta()" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center space-x-2 text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>FASTA</span>
                        </button>
                        <button onclick="clearSelection()" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Database Table View -->
            <div id="databaseView" class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left">
                                    <button onclick="selectAll()" class="flex items-center space-x-2 hover:text-green-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="selectAllIcon">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        </svg>
                                        <span class="text-xs font-medium text-gray-500">ALL</span>
                                    </button>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Accession</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Species</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Common Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gene</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Length</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sequence View -->
            <div id="sequenceView" class="hidden space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Selected Sequences</h2>
                    <div class="flex gap-2">
                        <button onclick="runBlast()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"></path>
                            </svg>
                            <span>Run BLAST</span>
                        </button>
                        <button onclick="backToDatabase()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Back to Database
                        </button>
                    </div>
                </div>
                <div id="sequenceCards"></div>
            </div>

            <!-- BLAST Results View -->
            <div id="blastView" class="hidden space-y-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">BLAST Results</h2>
                        <p class="text-sm text-gray-600" id="blastQueryInfo"></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportBlastResults()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Export</span>
                        </button>
                        <button onclick="backFromBlast()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Back
                        </button>
                    </div>
                </div>

                <!-- BLAST Tabs -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="border-b">
                        <nav class="flex space-x-4 px-6">
                            <button class="blast-tab active py-4 px-4 font-medium border-b-2 border-green-600 text-green-600" onclick="switchBlastTab('results')">
                                Results Table
                            </button>
                            <button class="blast-tab py-4 px-4 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" onclick="switchBlastTab('overview')">
                                Overview
                            </button>
                            <button class="blast-tab py-4 px-4 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" onclick="switchBlastTab('identity')">
                                Identity
                            </button>
                            <button class="blast-tab py-4 px-4 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" onclick="switchBlastTab('evalue')">
                                E-value
                            </button>
                        </nav>
                    </div>

                    <div class="p-6">
                        <!-- Results Table Tab -->
                        <div id="blastTab-results" class="blast-tab-content">
                            <div id="blastResultsContainer"></div>
                        </div>

                        <!-- Plots -->
                        <div id="blastTab-overview" class="blast-tab-content hidden">
                            <div id="overviewPlot" style="width: 100%; height: 500px;"></div>
                        </div>
                        <div id="blastTab-identity" class="blast-tab-content hidden">
                            <div id="identityPlot" style="width: 100%; height: 500px;"></div>
                        </div>
                        <div id="blastTab-evalue" class="blast-tab-content hidden">
                            <div id="evaluePlot" style="width: 100%; height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let entries = [];
        let filteredEntries = [];
        let selectedSequences = [];
        let blastResults = null;
        let currentView = 'database';

        // Load database
        async function loadDatabase() {
            try {
                console.log('Fetching thrips_database.json...');
                const response = await fetch('./thrips_database.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to load database file.`);
                }
                
                const data = await response.json();
                console.log(`Loaded ${data.length} sequences`);
                
                entries = data.map((entry, index) => ({
                    id: entry.id || index + 1,
                    accession: entry.accession || 'N/A',
                    species: entry.species || 'Unknown species',
                    common_name: entry.common_name || 'N/A',
                    gene: entry.gene || 'Unknown',
                    length: entry.length || 0,
                    sequence: entry.sequence || '',
                    collector: entry.collector || 'N/A',
                    collection_date: entry.collection_date || 'N/A'
                }));
                
                filteredEntries = [...entries];
                
                document.getElementById('loadingModal').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                updateCounts();
                renderTable();
                
            } catch (err) {
                console.error('Error loading data:', err);
                document.getElementById('loadingModal').style.display = 'none';
                document.getElementById('errorModal').classList.remove('hidden');
                document.getElementById('errorText').textContent = err.message;
            }
        }

        // Update counts
        function updateCounts() {
            document.getElementById('totalCount').textContent = entries.length.toLocaleString();
            document.getElementById('totalCount2').textContent = entries.length.toLocaleString();
            document.getElementById('filteredCount').textContent = filteredEntries.length.toLocaleString();
            document.getElementById('selectedCount').textContent = selectedSequences.length;
            
            if (selectedSequences.length > 0) {
                document.getElementById('selectionBar').classList.remove('hidden');
            } else {
                document.getElementById('selectionBar').classList.add('hidden');
            }
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            filteredEntries.forEach(entry => {
                const isSelected = selectedSequences.some(s => s.id === entry.id);
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 transition-colors ${isSelected ? 'bg-blue-50' : ''}`;
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <button onclick="toggleSelection(${entry.id})" class="hover:scale-110 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${isSelected ? 
                                    '<polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>' :
                                    '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>'
                                }
                            </svg>
                        </button>
                    </td>
                    <td class="px-6 py-4 text-sm font-mono text-blue-600">${entry.accession}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900 italic">${entry.species}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${entry.common_name}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">
                            ${entry.gene}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">${entry.length.toLocaleString()} bp</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Toggle selection
        function toggleSelection(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            
            const index = selectedSequences.findIndex(s => s.id === id);
            if (index >= 0) {
                selectedSequences.splice(index, 1);
            } else {
                selectedSequences.push(entry);
            }
            
            updateCounts();
            renderTable();
        }

        // Select all
        function selectAll() {
            if (selectedSequences.length === filteredEntries.length) {
                selectedSequences = [];
            } else {
                selectedSequences = [...filteredEntries];
            }
            updateCounts();
            renderTable();
        }

        // Clear selection
        function clearSelection() {
            selectedSequences = [];
            blastResults = null;
            updateCounts();
            renderTable();
            backToDatabase();
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            filteredEntries = entries.filter(entry => 
                entry.species.toLowerCase().includes(term) ||
                entry.common_name.toLowerCase().includes(term) ||
                entry.accession.toLowerCase().includes(term) ||
                entry.gene.toLowerCase().includes(term)
            );
            updateCounts();
            renderTable();
        });

        // Sort
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            const sortBy = e.target.value;
            filteredEntries.sort((a, b) => {
                if (sortBy === 'species') return a.species.localeCompare(b.species);
                if (sortBy === 'accession') return a.accession.localeCompare(b.accession);
                if (sortBy === 'length') return b.length - a.length;
                return 0;
            });
            renderTable();
        });

        // View selected sequences
        function viewSelectedSequences() {
            if (selectedSequences.length === 0) {
                alert('Please select at least one sequence');
                return;
            }
            
            document.getElementById('databaseView').classList.add('hidden');
            document.getElementById('sequenceView').classList.remove('hidden');
            
            const container = document.getElementById('sequenceCards');
            container.innerHTML = '';
            
            selectedSequences.forEach((entry, idx) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border p-6';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="text-lg font-bold text-gray-700">#${idx + 1}</span>
                                <h3 class="text-xl font-bold text-gray-900 italic">${entry.species}</h3>
                            </div>
                            <p class="text-gray-600">${entry.common_name}</p>
                        </div>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                            ${entry.gene}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 text-sm">
                        <div>
                            <div class="text-gray-500 mb-1">Accession</div>
                            <div class="font-mono font-medium text-blue-600">${entry.accession}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 mb-1">Length</div>
                            <div class="font-medium">${entry.length.toLocaleString()} bp</div>
                        </div>
                        <div>
                            <div class="text-gray-500 mb-1">Collection Date</div>
                            <div class="font-medium">${entry.collection_date}</div>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-semibold text-gray-700">Nucleotide Sequence</h4>
                            <button onclick="copySequence('${entry.sequence}')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md">
                                Copy
                            </button>
                        </div>
                        <div class="bg-gray-900 p-4 rounded-lg overflow-x-auto">
                            <pre class="text-xs font-mono text-green-400 whitespace-pre-wrap break-all">${entry.sequence}</pre>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function backToDatabase() {
            document.getElementById('sequenceView').classList.add('hidden');
            document.getElementById('blastView').classList.add('hidden');
            document.getElementById('databaseView').classList.remove('hidden');
        }

        function copySequence(sequence) {
            navigator.clipboard.writeText(sequence);
            alert('Sequence copied to clipboard!');
        }

        // Export FASTA
        function exportFasta() {
            if (selectedSequences.length === 0) {
                alert('No sequences selected');
                return;
            }
            
            const fasta = selectedSequences.map(seq => 
                `>${seq.accession} ${seq.species}\n${seq.sequence}`
            ).join('\n\n');
            
            const blob = new Blob([fasta], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'thrips_sequences.fasta';
            a.click();
        }

        // Run BLAST
        function runBlast() {
            if (selectedSequences.length === 0) {
                alert('Please select sequences to run BLAST');
                return;
            }
            
            const query = selectedSequences[0];
            const results = [];
            
            // Compare query against all selected sequences (except itself)
            selectedSequences.forEach(subject => {
                if (query.id === subject.id) return;
                
                const similarity = calculateSimilarity(query.sequence, subject.sequence);
                results.push({
                    queryId: query.accession,
                    querySpecies: query.species,
                    queryLength: query.length,
                    subjectId: subject.accession,
                    subjectSpecies: subject.species,
                    subjectLength: subject.length,
                    identity: similarity.identity,
                    coverage: similarity.coverage,
                    alignmentLength: similarity.alignLength,
                    matches: similarity.matches,
                    gaps: similarity.gaps,
                    evalue: similarity.evalue,
                    bitScore: similarity.bitScore
                });
            });
            
            results.sort((a, b) => b.identity - a.identity);
            blastResults = { query, results };
            
            showBlastResults();
        }

        // Calculate similarity
        function calculateSimilarity(seq1, seq2) {
            const minLen = Math.min(seq1.length, seq2.length);
            let matches = 0;
            
            for (let i = 0; i < minLen; i++) {
                if (seq1[i] === seq2[i]) matches++;
            }
            
            const identity = (matches / minLen) * 100;
            const coverage = (minLen / seq1.length) * 100;
            const gaps = Math.abs(seq1.length - seq2.length);
            const bitScore = matches * 2;
            const evalue = Math.exp(-bitScore / 10);
            
            return { identity, coverage, alignLength: minLen, matches, gaps, bitScore, evalue };
        }

        // Show BLAST results
        function showBlastResults() {
            document.getElementById('databaseView').classList.add('hidden');
            document.getElementById('sequenceView').classList.add('hidden');
            document.getElementById('blastView').classList.remove('hidden');
            
            document.getElementById('blastQueryInfo').textContent = 
                `Query: ${blastResults.query.species} (${blastResults.query.length.toLocaleString()} bp)`;
            
            const container = document.getElementById('blastResultsContainer');
            container.innerHTML = '';
            
            if (blastResults.results.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No matches found</div>';
                return;
            }
            
            blastResults.results.forEach((result, idx) => {
                const card = document.createElement('div');
                card.className = 'p-6 hover:bg-gray-50 border-b';
                
                const identityColor = result.identity >= 98 ? 'bg-green-100 text-green-700' :
                                     result.identity >= 95 ? 'bg-yellow-100 text-yellow-700' :
                                     'bg-red-100 text-red-700';
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="text-lg font-bold text-gray-700">#${idx + 1}</span>
                                <h3 class="text-lg font-bold text-gray-900 italic">${result.subjectSpecies}</h3>
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${identityColor}">
                                    ${result.identity.toFixed(2)}% Identity
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Accession</p>
                            <p class="font-mono font-medium text-blue-600">${result.subjectId}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Align Length</p>
                            <p class="font-medium">${result.alignmentLength.toLocaleString()} bp</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Identities</p>
                            <p class="font-medium">${result.matches}/${result.alignmentLength}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Gaps</p>
                            <p class="font-medium">${result.gaps}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">E-value</p>
                            <p class="font-medium">${result.evalue.toExponential(2)}</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t">
                        <div class="flex items-center space-x-2">
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="${result.identity >= 98 ? 'bg-green-500' : result.identity >= 95 ? 'bg-yellow-500' : 'bg-red-500'} h-2 rounded-full" 
                                     style="width: ${result.identity}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-medium w-12">${result.identity.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Generate plots
            plotAlignmentOverview();
            plotIdentityDistribution();
            plotEvalueDistribution();
        }

        // Switch BLAST tabs
        function switchBlastTab(tabName) {
            document.querySelectorAll('.blast-tab').forEach(btn => {
                btn.classList.remove('active', 'border-green-600', 'text-green-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelectorAll('.blast-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            event.target.classList.add('active', 'border-green-600', 'text-green-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');
            
            document.getElementById(`blastTab-${tabName}`).classList.remove('hidden');
        }

        // Plot alignment overview
        function plotAlignmentOverview() {
            if (!blastResults || blastResults.results.length === 0) return;
            
            const traces = [];
            const yLabels = [];
            
            // Query bar
            traces.push({
                x: [blastResults.query.length],
                y: [0],
                type: 'bar',
                orientation: 'h',
                name: 'Query',
                marker: { color: 'lightgray' },
                hoverinfo: 'x'
            });
            
            yLabels.push(blastResults.query.accession);
            
            // Top 10 hits
            blastResults.results.slice(0, 10).forEach((hit, idx) => {
                const color = hit.identity >= 98 ? 'green' : 
                             hit.identity >= 95 ? 'gold' : 'red';
                
                traces.push({
                    x: [hit.alignmentLength],
                    y: [idx + 1],
                    type: 'bar',
                    orientation: 'h',
                    name: hit.subjectId.substring(0, 20),
                    marker: { color: color, opacity: 0.7 },
                    showlegend: false,
                    hovertemplate: `${hit.subjectSpecies}<br>Identity: ${hit.identity.toFixed(1)}%<br>Length: ${hit.alignmentLength}<extra></extra>`
                });
                
                yLabels.push(hit.subjectId);
            });
            
            const layout = {
                title: 'Alignment Coverage Overview',
                xaxis: { title: 'Position (bp)' },
                yaxis: { 
                    tickmode: 'array',
                    tickvals: Array.from({length: yLabels.length}, (_, i) => i),
                    ticktext: yLabels.map(l => l.substring(0, 30))
                },
                barmode: 'overlay',
                height: Math.max(400, yLabels.length * 50),
                margin: { l: 150 }
            };
            
            Plotly.newPlot('overviewPlot', traces, layout, {responsive: true});
        }

        // Plot identity distribution
        function plotIdentityDistribution() {
            if (!blastResults || blastResults.results.length === 0) return;
            
            const bins = [0, 70, 80, 90, 95, 98, 100];
            const counts = new Array(bins.length - 1).fill(0);
            const labels = ['<70%', '70-80%', '80-90%', '90-95%', '95-98%', '98-100%'];
            const colors = ['red', 'orange', 'gold', 'lightgreen', 'green', 'darkgreen'];
            
            blastResults.results.forEach(result => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (result.identity >= bins[i] && result.identity < bins[i + 1]) {
                        counts[i]++;
                        break;
                    }
                }
            });
            
            const trace = {
                x: labels,
                y: counts,
                type: 'bar',
                marker: { color: colors }
            };
            
            const layout = {
                title: 'Identity Distribution',
                xaxis: { title: 'Identity Range' },
                yaxis: { title: 'Number of Hits' },
                height: 400
            };
            
            Plotly.newPlot('identityPlot', [trace], layout, {responsive: true});
        }

        // Plot E-value distribution
        function plotEvalueDistribution() {
            if (!blastResults || blastResults.results.length === 0) return;
            
            const evalues = blastResults.results.map(r => 
                r.evalue > 0 ? Math.log10(r.evalue) : -180
            );
            
            const trace = {
                x: evalues,
                type: 'histogram',
                nbinsx: 30,
                marker: { color: 'steelblue' }
            };
            
            const layout = {
                title: 'E-value Distribution',
                xaxis: { title: 'log10(E-value)' },
                yaxis: { title: 'Number of Hits' },
                height: 400
            };
            
            Plotly.newPlot('evaluePlot', [trace], layout, {responsive: true});
        }

        // Export BLAST results
        function exportBlastResults() {
            if (!blastResults || blastResults.results.length === 0) {
                alert('No results to export');
                return;
            }
            
            const csv = [
                'Query,Query_Species,Subject,Subject_Species,Identity_%,Coverage_%,E-value,Bit_Score,Align_Length,Gaps,Matches'
            ];
            
            blastResults.results.forEach(r => {
                csv.push(`${r.queryId},${r.querySpecies},${r.subjectId},${r.subjectSpecies},${r.identity.toFixed(2)},${r.coverage.toFixed(2)},${r.evalue.toExponential(2)},${r.bitScore.toFixed(1)},${r.alignmentLength},${r.gaps},${r.matches}`);
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'blast_results.csv';
            a.click();
        }

        function backFromBlast() {
            document.getElementById('blastView').classList.add('hidden');
            document.getElementById('sequenceView').classList.remove('hidden');
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', loadDatabase);
    </script>
</body>
</html>
